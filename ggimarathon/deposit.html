<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤</title>

<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Pretendard, sans-serif;
    display: flex;
    flex-direction: column;
    background: #fafafa;
    overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì œê±° */
  }

  h2 {
    margin: 18px 20px 10px;
    font-size: 22px;
    font-weight: 700;
    flex-shrink: 0;
  }

  #controls {
    flex-shrink: 0;
    display: flex;
    gap: 10px;
    padding: 0 20px 10px;
    align-items: center;
  }

  #sheetSelect, #search {
    padding: 10px;
    font-size: 15px;
    border-radius: 6px;
    border: 1px solid #bbb;
  }
  #search { flex: 1; }

  .table-wrap {
    flex: 1 1 auto;     /* ë‚¨ëŠ” ê³µê°„ ê½‰ ì±„ì›€ */
    min-height: 0;      /* flex overflow fix */
    overflow-y: auto;
    overflow-x: auto;
    background: #fff;
    border-top: 2px solid #555;
  }

  table {
    width: 100%;
    min-width: 900px;
    border-collapse: collapse;
    font-size: 15px;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    white-space: nowrap;
    text-align: center;
  }

  th {
    background: #f2f2f2;
    position: sticky;
    top: 0;
    cursor: pointer;
    font-weight: 600;
    z-index: 10;
  }

  th.sorted-asc::after { content: " â–²"; }
  th.sorted-desc::after { content: " â–¼"; }

  .alert {
    color: #c40000;
    font-weight: 700;
  }

  /* ğŸ“Œ NOTICEë¥¼ í•­ìƒ ì•„ë˜ ê³ ì • */
  .notice {
    flex-shrink: 0;
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    background: #fff7d4;
    border-top: 1px solid #ebcf79;
    padding: 14px 20px;
    font-size: 14px;
    line-height: 1.45;
  }

  /* NOTICE ê³µê°„ í™•ë³´ */
  .bottom-space {
    height: 70px;
    flex-shrink: 0;
  }

</style>
</head>

<body>

<h2>ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤</h2>

<div id="controls">
  <select id="sheetSelect"></select>
  <input type="text" id="search" placeholder="ê²€ìƒ‰ (ì´ë¦„/ìƒë…„ì›”ì¼)">
</div>

<div class="table-wrap">
<table id="table">
  <thead></thead>
  <tbody></tbody>
</table>
</div>

<!-- Notice ê³ ì •í•˜ë¯€ë¡œ ì•„ë˜ ì—¬ìœ ê³µê°„ í™•ë³´ -->
<div class="bottom-space"></div>

<div class="notice">
  ìƒë…„ì›”ì¼ ë¯¸ê¸°ì¬ ë˜ëŠ” ì°¸ê°€ ë¯¸ë“±ë¡ ì‹œ<br>
  <strong>ì„±í•¨ + ìƒë…„ì›”ì¼ + ì…ê¸ˆë‚´ì—­ ì‚¬ì§„</strong> ì²¨ë¶€í•˜ì—¬ ë¬¸ì˜í•´ì£¼ì„¸ìš”.<br>
  ì˜ˆ) ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤. 1ë²ˆ ê¹€ìˆ˜ì› 250101
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
let workbook, header, tableData = [], sortState = {};
let amountColIdx = -1;
const filePath = "./data/deposit.xlsx";

/*------------------------------
  ìˆ«ì í¬ë§·(ì½¤ë§ˆ ìë™ ì²˜ë¦¬)
------------------------------*/
const formatNumber = (v) => {
  if (v === null || v === undefined) return v;
  let s = String(v).replace(/,/g, "").replace(/\s/g, "");
  if (s === "" || isNaN(s)) return v;
  return Number(s).toLocaleString();
};

/*------------------------------
  Excel ë¡œë“œ
------------------------------*/
fetch(filePath)
  .then(r => r.arrayBuffer())
  .then(buffer => {
    workbook = XLSX.read(buffer, { type: "array" });
    const sel = document.querySelector("#sheetSelect");

    workbook.SheetNames.forEach(s =>
      sel.add(new Option(s, s))
    );

    loadSheet(sel.value);
    sel.onchange = () => loadSheet(sel.value);
  });

function loadSheet(name) {
  const rows = XLSX.utils.sheet_to_json(
    workbook.Sheets[name],
    { header: 1 }
  );

  header = rows[0] || [];
  tableData = rows.slice(1);

  detectAmountColumn();
  renderHeader();
  renderTable(tableData);
}

/*------------------------------
  ê¸ˆì•¡ ì»¬ëŸ¼ íŒë³„ : í—¤ë” > ìˆ«ìë¹„ìœ¨ ìš°ì„ 
------------------------------*/
function detectAmountColumn() {
  amountColIdx = -1;

  // 1) í—¤ë” ìš°ì„ 
  header.forEach((h, i) => {
    if (typeof h === "string" && /(ê¸ˆì•¡|ì›|\(ì›\))/g.test(h))
      amountColIdx = i;
  });
  if (amountColIdx !== -1) return;

  // 2) ìˆ«ì ê°€ì¥ ë§ì€ ì—´ ì¶”ì • (fallback)
  let scores = header.map(() => 0);
  tableData.forEach(row => row.forEach((v, i) => {
    let s = String(v).replace(/,/g,"").replace(/\s/g,"");
    if(s !== "" && !isNaN(s)) scores[i]++;
  }));
  
  let idx = scores.indexOf(Math.max(...scores));
  amountColIdx = idx <= 0 ? 1 : idx;
}

/*------------------------------
  í…Œì´ë¸” ë Œë”ë§
------------------------------*/
function renderHeader() {
  const thead = document.querySelector("#table thead");
  thead.innerHTML = "";
  const tr = document.createElement("tr");

  // ìë™ ìˆœë²ˆ
  const thNo = document.createElement("th");
  thNo.textContent = "ìˆœë²ˆ";
  tr.appendChild(thNo);

  header.slice(1).forEach((c, i) => {
    const th = document.createElement("th");
    th.textContent = c;
    th.onclick = () => sortTable(i + 1, th);
    tr.appendChild(th);
  });

  thead.appendChild(tr);
}

function renderTable(data) {
  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";

  data.forEach((row, idx) => {
    const tr = document.createElement("tr");

    const tdNo = document.createElement("td");
    tdNo.textContent = idx + 1;
    tr.appendChild(tdNo);

    row.slice(1).forEach((v, i) => {
      const realIdx = i + 1;
      const td = document.createElement("td");
      if(realIdx === amountColIdx) v = formatNumber(v);
      td.textContent = v ?? "";
      if(realIdx === row.length - 1 && v) td.classList.add("alert");
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

/*------------------------------
  ì •ë ¬ ê¸°ëŠ¥
------------------------------*/
function sortTable(idx, th) {
  if(idx === 0) return;

  const order = sortState[idx] === "asc" ? "desc" : "asc";
  sortState[idx] = order;

  document.querySelectorAll("th")
    .forEach(h => h.classList.remove("sorted-asc", "sorted-desc"));
  th.classList.add(order === "asc" ? "sorted-asc" : "sorted-desc");

  tableData.sort((a,b)=>{
    let A = String(a[idx] ?? "").replace(/,/g,"");
    let B = String(b[idx] ?? "").replace(/,/g,"");
    let nA = parseFloat(A), nB = parseFloat(B);

    if(!isNaN(nA) && !isNaN(nB))
      return order==="asc" ? nA-nB : nB-nA;
    return order==="asc"
      ? A.localeCompare(B)
      : B.localeCompare(A);
  });

  renderTable(tableData);
}

/*------------------------------
  ê²€ìƒ‰ ê¸°ëŠ¥:
  ì²« ì—´(ìˆœë²ˆ) + ë§ˆì§€ë§‰ ì—´(ë¹„ê³ ) ì œì™¸ ì „ì²´ ê²€ìƒ‰
------------------------------*/
document.querySelector("#search").oninput = function(){
  const q = this.value.toLowerCase();
  const tbody = document.querySelector("#table tbody");

  Array.from(tbody.rows).forEach((tr, i)=>{
    let visible = false;
    const row = tableData[i];

    row.slice(1, row.length-1).forEach(v=>{
      if(String(v).toLowerCase().includes(q)) visible = true;
    });

    tr.style.display = visible ? "" : "none";
  });

  reindex();
};

function reindex(){
  const rows=document.querySelectorAll("#table tbody tr");
  let n=1;
  rows.forEach(tr=>{
    if(tr.style.display!=="none")
      tr.cells[0].textContent=n++;
  });
}
</script>

</body>
</html>
