<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤</title>

<style>
  html, body {
    height:100%; margin:0;
    font-family: Pretendard, sans-serif;
    display:flex; flex-direction:column;
    background:#fafafa;
  }

  h2 { margin:18px 20px 10px; font-size:22px; font-weight:700; }

  #controls {
    display:flex; gap:10px;
    padding:0 20px 10px;
    align-items:center;
  }
  #sheetSelect, #search {
    padding:10px; font-size:15px;
    border-radius:6px; border:1px solid #bbb;
  }
  #search { flex:1; }

  .table-wrap {
    flex:1; overflow-y:auto; overflow-x:auto;
    border-top:2px solid #555;
    background:#fff;
  }

  table {
    width:100%; min-width:900px;
    border-collapse:collapse;
    font-size:15px;
  }

  th, td {
    border:1px solid #ddd;
    padding:10px; white-space:nowrap;
    text-align:center;
  }

  th {
    background:#f2f2f2;
    position:sticky; top:0;
    cursor:pointer; font-weight:600;
  }

  th.sorted-asc::after { content:" â–²"; }
  th.sorted-desc::after { content:" â–¼"; }

  .alert { color:#c40000; font-weight:700; }

  .notice {
    font-size:14px;
    background:#fff7d4;
    border-top:1px solid #ebcf79;
    padding:14px 20px;
    line-height:1.4;
  }
</style>
</head>

<body>

<h2>ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤</h2>

<div id="controls">
  <select id="sheetSelect"></select>
  <input type="text" id="search" placeholder="ê²€ìƒ‰ (ì´ë¦„/ìƒë…„ì›”ì¼)">
</div>

<div class="table-wrap">
<table id="table">
  <thead></thead>
  <tbody></tbody>
</table>
</div>

<div class="notice">
  ìƒë…„ì›”ì¼ ë¯¸ê¸°ì¬ ë˜ëŠ” ì°¸ê°€ ë¯¸ë“±ë¡ ì‹œ<br>
  <strong>ì„±í•¨ + ìƒë…„ì›”ì¼ + ì…ê¸ˆë‚´ì—­ ì‚¬ì§„</strong> ì²¨ë¶€í•˜ì—¬ ë¬¸ì˜í•´ì£¼ì„¸ìš”.<br>
  ì˜ˆ) ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤. 1ë²ˆ ê¹€ìˆ˜ì› 250101
</div>


<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
let workbook, header, tableData = [], sortState={};
let amountColIdx = -1;

const filePath = "./data/deposit.xlsx";

// ê¸ˆì•¡ Formatting
const formatNumber = (v) => {
  if(v === null || v === "" || isNaN(v)) return v;
  return Number(v).toLocaleString();
};

// Excel ë¡œë“œ
fetch(filePath)
  .then(r => r.arrayBuffer())
  .then(data => {
    workbook = XLSX.read(data, { type:"array" });

    const sel = document.querySelector("#sheetSelect");
    workbook.SheetNames.forEach(s => sel.add(new Option(s,s)));

    loadSheet(sel.value);
    sel.onchange = () => loadSheet(sel.value);
  });

// ê¸ˆì•¡ ì—´ ìë™ íŒë³„
function detectAmountColumn(){
  let scores = header.map(()=>0);
  tableData.forEach(r=>r.forEach((v,i)=>{
    if(!isNaN(v) && v !== null && v !== "") scores[i]++;
  }));
  let idx = scores.indexOf(Math.max(...scores));
  amountColIdx = idx <= 0 ? 1 : idx;
}

function loadSheet(name){
  const rows = XLSX.utils.sheet_to_json(
      workbook.Sheets[name], { header:1 });

  header = rows[0];
  tableData = rows.slice(1);

  detectAmountColumn();
  renderHeader();
  renderTable(tableData);
}

function renderHeader(){
  const thead = document.querySelector("#table thead");
  thead.innerHTML = "";
  const tr = document.createElement("tr");

  const thNo=document.createElement("th");
  thNo.textContent="ìˆœë²ˆ";
  tr.appendChild(thNo);

  header.slice(1).forEach((c,i)=>{
    const th=document.createElement("th");
    th.textContent = c;
    th.onclick = ()=>sortTable(i+1,th);
    tr.appendChild(th);
  });

  thead.appendChild(tr);
}

function renderTable(data){
  const tbody=document.querySelector("#table tbody");
  tbody.innerHTML="";

  data.forEach((row,idx)=>{
    const tr=document.createElement("tr");

    const tdNo=document.createElement("td");
    tdNo.textContent=idx+1;
    tr.appendChild(tdNo);

    row.slice(1).forEach((v,i)=>{
      const td=document.createElement("td");
      const col=i+1;
      if(col === amountColIdx) v = formatNumber(v);
      td.textContent=v ?? "";
      if(col === row.length-1 && v) td.classList.add("alert");
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

function sortTable(idx, th){
  if(idx===0) return;
  const order = sortState[idx]==="asc"?"desc":"asc";
  sortState[idx]=order;

  document.querySelectorAll("th")
    .forEach(th => th.classList.remove("sorted-asc","sorted-desc"));
  th.classList.add(order==="asc"?"sorted-asc":"sorted-desc");

  tableData.sort((a,b)=>{
    const A=a[idx]??"", B=b[idx]??"";
    const nA=parseFloat(A), nB=parseFloat(B);
    if(!isNaN(nA)&&!isNaN(nB))
      return order==="asc"?nA-nB:nB-nA;
    return order==="asc"
      ?String(A).localeCompare(String(B))
      :String(B).localeCompare(String(A));
  });
  renderTable(tableData);
}

// ê²€ìƒ‰ â€” ì²«ì—´(ìˆœë²ˆ) & ë§ˆì§€ë§‰ì—´(ë¹„ê³ ) ì œì™¸ ì „ì²´ ê²€ìƒ‰
document.querySelector("#search").oninput = function(){
  const q=this.value.toLowerCase();
  const tbody=document.querySelector("#table tbody");

  Array.from(tbody.rows).forEach((tr, rowIdx)=>{
    let found=false;
    const visibleCols = tableData[rowIdx].slice(1, -1); // ì²«X, ë§ˆì§€ë§‰X
    visibleCols.forEach(v=>{
      if(String(v).toLowerCase().includes(q)) found=true;
    });
    tr.style.display = found ? "" : "none";
  });

  // ğŸ”¥ ê²€ìƒ‰ í›„ ìë™ ë²ˆí˜¸ ì¬ì •ë ¬
  reindex();
};

function reindex(){
  const rows = document.querySelectorAll("#table tbody tr");
  let idx=1;
  rows.forEach(tr=>{
    if(tr.style.display!=="none"){
      tr.cells[0].textContent=idx++;
    }
  });
}
</script>

</body>
</html>
