<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤</title>

<style>
  html, body {
    height: 100%; margin: 0; padding: 0;
    font-family: Pretendard, sans-serif;
    display: flex; flex-direction: column;
    background: #fafafa;
    overflow: hidden;
  }

  h2 {
    margin: 18px 20px 10px;
    font-size: 22px; font-weight: 700;
    flex-shrink: 0;
  }

  #controls {
    flex-shrink: 0;
    display: flex; gap: 10px;
    padding: 0 20px 10px;
    align-items: center;
  }

  #sheetSelect, #search {
    padding: 10px;
    font-size: 15px;
    border-radius: 6px;
    border: 1px solid #bbb;
  }
  #search { flex: 1; }

  .table-wrap {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
    overflow-x: auto;
    background: #fff;
    border-top: 2px solid #555;
  }

  table {
    width: 100%;
    min-width: 900px;
    border-collapse: collapse;
    font-size: 15px;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    white-space: nowrap;
    text-align: center;
  }

  th {
    background: #f2f2f2;
    position: sticky;
    top: 0;
    cursor: pointer;
    font-weight: 600;
    z-index: 10;
  }

  th.sorted-asc::after { content: " â–²"; }
  th.sorted-desc::after { content: " â–¼"; }

  .alert {
    color: #c40000;
    font-weight: 700;
  }

  /* ì•„ë˜ ì•ˆë‚´ë¬¸êµ¬ ê³ ì • */
  .notice {
    flex-shrink: 0;
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    background: #fff7d4;
    border-top: 1px solid #ebcf79;
    padding: 14px 20px;
    font-size: 14px;
    line-height: 1.45;
  }

  .bottom-space {
    height: 80px;
    flex-shrink: 0;
  }

  /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
  #loading {
    position: fixed;
    top: 0; left:0;
    width: 100%; height: 100%;
    background: rgba(255,255,255,.75);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .loader {
    width: 38px; height: 38px;
    border: 4px solid #ccc;
    border-top-color: #007aff;
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg);} }
  .hidden { display:none!important; }
</style>
</head>

<body>

<h2>ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤</h2>

<div id="controls">
  <select id="sheetSelect"></select>
  <input type="text" id="search" placeholder="ê²€ìƒ‰ (ì´ë¦„/ìƒë…„ì›”ì¼)">
</div>

<div class="table-wrap">
<table id="table">
  <thead></thead>
  <tbody></tbody>
</table>
</div>

<div class="bottom-space"></div>

<div class="notice">
  ìƒë…„ì›”ì¼ ë¯¸ê¸°ì¬ ë˜ëŠ” ì°¸ê°€ ë¯¸ë“±ë¡ ì‹œ<br>
  <strong>ì„±í•¨ + ìƒë…„ì›”ì¼ + ì…ê¸ˆë‚´ì—­ ì‚¬ì§„</strong> ì²¨ë¶€í•˜ì—¬ ë¬¸ì˜í•´ì£¼ì„¸ìš”.<br>
  ì˜ˆ) ì…ê¸ˆìë¥¼ ì°¾ìŠµë‹ˆë‹¤. 1ë²ˆ ê¹€ìˆ˜ì› 250101
</div>

<div id="loading" class="hidden">
  <div class="loader"></div>
</div>


<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
let workbook, header, tableData = [], sortState = {};
let amountColIdx = -1;
const filePath = "./data/deposit.xlsx";

/** ìˆ«ì í¬ë§·: ì½¤ë§ˆÂ·ê³µë°±Â·ë¬¸ì ì œê±° í›„ ìˆ«ìë¡œ ë³€í™˜ **/
const formatNumber = (v) => {
  if (v === null || v === undefined) return v;
  let s = String(v).replace(/[^\d.-]/g, "");
  if (s === "" || isNaN(s)) return v;
  return Number(s).toLocaleString();
};

// ë¡œë”© í‘œì‹œ ì‹œì‘
document.querySelector("#loading").classList.remove("hidden");

// Excel ë¡œë“œ
fetch(filePath)
  .then(r => r.arrayBuffer())
  .then(buffer => {
    workbook = XLSX.read(buffer, { type:"array" });

    const sel = document.querySelector("#sheetSelect");
    workbook.SheetNames.forEach(s =>
      sel.add(new Option(s,s))
    );

    loadSheet(sel.value);
    sel.onchange = () => loadSheet(sel.value);
  });

function loadSheet(name){
  const rows = XLSX.utils.sheet_to_json(
    workbook.Sheets[name], { header:1 }
  );

  header = rows[0] || [];

  // ğŸ”¥ ë¹ˆ í–‰ ì œê±°
  tableData = rows.slice(1)
    .filter(row => row.some(v =>
      v !== null && v !== "" && v !== undefined
    ));

  detectAmountColumn();
  renderHeader();
  renderTable(tableData);

  // ë¡œë”© ì¢…ë£Œ
  document.querySelector("#loading").classList.add("hidden");

  // ìŠ¤í¬ë¡¤ ìƒë‹¨ìœ¼ë¡œ ì´ˆê¸°í™”
  document.querySelector(".table-wrap").scrollTop = 0;
}

// ê¸ˆì•¡ì—´ íŒë³„
function detectAmountColumn(){
  amountColIdx = -1;
  header.forEach((h,i)=>{
    if(typeof h==="string" && /(ê¸ˆì•¡|ì›|\(ì›\))/g.test(h))
      amountColIdx = i;
  });
  if(amountColIdx !== -1) return;

  let scores = header.map(()=>0);
  tableData.forEach(r=>r.forEach((v,i)=>{
    let s=String(v).replace(/[^\d.-]/g,"");
    if(s!=="" && !isNaN(s)) scores[i]++;
  }));
  let idx=scores.indexOf(Math.max(...scores));
  amountColIdx = idx<=0 ? 1 : idx;
}

function renderHeader(){
  const thead=document.querySelector("#table thead");
  thead.innerHTML="";
  const tr=document.createElement("tr");

  const thNo=document.createElement("th");
  thNo.textContent="ìˆœë²ˆ";
  tr.appendChild(thNo);

  header.slice(1).forEach((c,i)=>{
    const th=document.createElement("th");
    th.textContent=c;
    th.onclick=()=>sortTable(i+1,th);
    tr.appendChild(th);
  });

  thead.appendChild(tr);
}

function renderTable(data){
  const tbody=document.querySelector("#table tbody");
  tbody.innerHTML="";

  data.forEach((row,idx)=>{
    const tr=document.createElement("tr");

    const tdNo=document.createElement("td");
    tdNo.textContent=idx+1;
    tr.appendChild(tdNo);

    row.slice(1).forEach((v,i)=>{
      const realIdx=i+1;
      const td=document.createElement("td");
      if(realIdx === amountColIdx)
        v = formatNumber(v);
      td.textContent=v??"";
      if(realIdx===row.length-1 && v)
        td.classList.add("alert");
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

function sortTable(idx,th){
  if(idx===0) return;

  const order = sortState[idx]==="asc" ? "desc":"asc";
  sortState[idx]=order;

  document.querySelectorAll("th")
    .forEach(h=>h.classList.remove("sorted-asc","sorted-desc"));
  th.classList.add(order==="asc" ? "sorted-asc":"sorted-desc");

  tableData.sort((a,b)=>{
    let A=String(a[idx]??"").replace(/[^\d.-]/g,"");
    let B=String(b[idx]??"").replace(/[^\d.-]/g,"");
    const nA=parseFloat(A), nB=parseFloat(B);
    if(!isNaN(nA)&&!isNaN(nB))
      return order==="asc"?nA-nB:nB-nA;
    return order==="asc"
      ?String(a[idx]).localeCompare(b[idx])
      :String(b[idx]).localeCompare(a[idx]);
  });

  renderTable(tableData);
}

// ê²€ìƒ‰ ê¸°ëŠ¥
document.querySelector("#search").oninput = function(){
  const q=this.value.toLowerCase();
  const tbody=document.querySelector("#table tbody");

  Array.from(tbody.rows).forEach((tr,i)=>{
    let visible=false;
    const row=tableData[i];
    row.slice(1,row.length-1).forEach(v=>{
      if(String(v).toLowerCase().includes(q)) visible=true;
    });
    tr.style.display = visible ? "" : "none";
  });
  reindex();
};

function reindex(){
  const rows=document.querySelectorAll("#table tbody tr");
  let num=1;
  rows.forEach(tr=>{
    if(tr.style.display!=="none")
      tr.cells[0].textContent=num++;
  });
}
</script>

</body>
</html>
